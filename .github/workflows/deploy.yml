# =============================================================================
# GitHub Actions - Production Deployment (Blue-Green)
# =============================================================================
# Triggers on push to main branch
# Deploys to VPS with zero-downtime blue-green deployment
#
# Container Naming:
#   COMPOSE_PROJECT_NAME is derived from repository name, ensuring unique
#   container names even when the same project is forked/duplicated.
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Build and Push Docker Image
  # ===========================================================================
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Deploy to VPS (Blue-Green Deployment)
  # ===========================================================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            # =================================================================
            # Dynamic Project Configuration
            # =================================================================
            # Extract repository name from full path (e.g., "owner/repo" -> "repo")
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

            # Use repo name as project identifier (sanitized for Docker)
            PROJECT_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')

            # Export for Docker Compose - ALL containers will be prefixed with this
            export COMPOSE_PROJECT_NAME="$PROJECT_NAME"

            # Project-specific paths
            APP_DIR="/opt/$PROJECT_NAME"
            COMPOSE_FILE="$APP_DIR/docker-compose.prod.yml"
            REPO_URL="https://${{ secrets.GH_SECRET }}@github.com/${{ github.repository }}.git"

            echo "ðŸš€ Deploying project: $PROJECT_NAME"
            echo "ðŸ“ App directory: $APP_DIR"

            # =================================================================
            # Repository Setup
            # =================================================================
            mkdir -p $APP_DIR
            cd $APP_DIR

            if [ -d ".git" ]; then
              if ! git rev-parse --verify main >/dev/null 2>&1; then
                echo "ðŸ“‚ Incomplete git directory detected, re-initializing..."
                rm -rf .git
              fi
            fi

            if [ ! -d ".git" ]; then
              echo "ðŸ“‚ Cloning repository..."
              git init
              git remote add origin $REPO_URL
              git fetch origin
              git checkout -f main
              git branch --set-upstream-to=origin/main main
            else
              echo "ðŸ“‚ Pulling latest changes..."
              git remote set-url origin $REPO_URL
              git fetch origin
              git checkout main
              git reset --hard origin/main
            fi

            # =================================================================
            # Container Deployment
            # =================================================================
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            docker compose -f $COMPOSE_FILE pull

            echo "ðŸ”µ Starting Blue-Green Deployment for $PROJECT_NAME..."

            # Stop and remove orphaned containers from this project only
            docker compose -f $COMPOSE_FILE down --remove-orphans 2>/dev/null || true

            # Scale up new containers (green)
            docker compose -f $COMPOSE_FILE up -d --scale app=6 --no-recreate

            # Wait for new containers to be healthy
            sleep 15

            # Run database migrations
            echo "ðŸ“Š Running database migrations..."
            docker compose -f $COMPOSE_FILE exec -T app yarn migrate:shards || true

            # Rolling restart (graceful)
            docker compose -f $COMPOSE_FILE up -d --force-recreate --scale app=3

            # =================================================================
            # Cleanup
            # =================================================================
            echo "ðŸ§¹ Cleaning up old images (keeping last 5)..."
            docker images --format "{{.Repository}}:{{.Tag}} {{.ID}}" | grep "$PROJECT_NAME" | tail -n +6 | awk '{print $2}' | xargs -r docker rmi -f 2>/dev/null || true

            echo "âœ… Deployment of $PROJECT_NAME complete!"
            echo "ðŸ“¦ Containers: $(docker ps --filter "name=$PROJECT_NAME" --format '{{.Names}}' | tr '\n' ' ')"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            PROJECT_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]-')
            APP_DIR="/opt/$PROJECT_NAME"

            sleep 10
            cd $APP_DIR
            source .env 2>/dev/null || true
            PORT=${PORT:-3001}
            curl -f http://localhost:$PORT/health || exit 1
            echo "âœ… Health check passed for $PROJECT_NAME!"
